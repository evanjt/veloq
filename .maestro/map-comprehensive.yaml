# Comprehensive Map Integration Test
# Tests all map features: activities, routes, sections, popups, filters, and toggles
# Demo activity IDs use format: demo-YYYY-MM-DD-N (reference date: 2026-01-15)
# NOTE: All demo activities are in different geographic locations, so we use the same
# activity marker throughout to ensure reliable testing

appId: com.veloq.app
---
- launchApp

- extendedWaitUntil:
    visible:
      id: "login-screen"
    timeout: 30000

- tapOn:
    id: "login-demo-button"

- extendedWaitUntil:
    visible:
      id: "home-screen"
    timeout: 15000

# Navigate to map screen
- openLink: "veloq://map"

- extendedWaitUntil:
    visible:
      id: "map-screen"
    timeout: 15000

# Wait for map controls to load
- extendedWaitUntil:
    visible:
      id: "map-toggle-activities"
    timeout: 10000

# =============================================================================
# SECTION 1: Activity Markers - Basic Interaction
# =============================================================================

# Tap on activity marker
- tapOn:
    id: "map-activity-marker-demo-2026-01-14-0"
    optional: true

# Wait for popup to appear
- extendedWaitUntil:
    visible:
      id: "activity-popup"
    timeout: 3000
    optional: true

# Zoom to the activity
- tapOn:
    id: "activity-popup-zoom"
    optional: true

# Wait for zoom animation
- extendedWaitUntil:
    visible:
      id: "activity-popup"
    timeout: 2000
    optional: true

# Close the popup
- tapOn:
    id: "activity-popup-close"
    optional: true

# Verify popup is closed
- extendedWaitUntil:
    notVisible:
      id: "activity-popup"
    timeout: 2000
    optional: true

# =============================================================================
# SECTION 2: Activity Details Navigation
# =============================================================================

# Reset map and tap same activity again
- openLink: "veloq://map"

- extendedWaitUntil:
    visible:
      id: "map-screen"
    timeout: 5000

- extendedWaitUntil:
    visible:
      id: "map-toggle-activities"
    timeout: 3000

# Tap the same activity marker
- tapOn:
    id: "map-activity-marker-demo-2026-01-14-0"
    optional: true

- extendedWaitUntil:
    visible:
      id: "activity-popup"
    timeout: 3000
    optional: true

# View activity details
- tapOn:
    id: "activity-popup-view-details"
    optional: true

# Wait for activity detail screen to load
- extendedWaitUntil:
    visible:
      id: "activity-detail-screen"
    timeout: 10000
    optional: true

# Go back to map
- openLink: "veloq://map"

- extendedWaitUntil:
    visible:
      id: "map-screen"
    timeout: 10000

# =============================================================================
# SECTION 3: Repeated Marker Interactions (Stress Test)
# =============================================================================

# Test tapping the same marker multiple times
- repeat:
    times: 3
    commands:
      - tapOn:
          id: "map-activity-marker-demo-2026-01-14-0"
          optional: true
      - extendedWaitUntil:
          visible:
            id: "activity-popup"
          timeout: 2000
          optional: true
      - tapOn:
          id: "activity-popup-close"
          optional: true
      - extendedWaitUntil:
          notVisible:
            id: "activity-popup"
          timeout: 2000
          optional: true

# =============================================================================
# SECTION 4: Sport Type Filters
# =============================================================================

# Filter by Ride
- tapOn:
    id: "map-filter-ride"
    optional: true

- extendedWaitUntil:
    visible:
      id: "map-screen"
    timeout: 2000

# Filter by Run
- tapOn:
    id: "map-filter-run"
    optional: true

- extendedWaitUntil:
    visible:
      id: "map-screen"
    timeout: 2000

# Filter by multiple types
- tapOn:
    id: "map-filter-swim"
    optional: true

- tapOn:
    id: "map-filter-hike"
    optional: true

# Clear all filters
- tapOn:
    id: "map-filter-clear"
    optional: true

# =============================================================================
# SECTION 5: Layer Toggles
# =============================================================================

# Toggle routes layer
- tapOn:
    id: "map-toggle-routes"
    optional: true

- extendedWaitUntil:
    visible:
      id: "map-screen"
    timeout: 2000

# Toggle sections layer
- tapOn:
    id: "map-toggle-sections"
    optional: true

- extendedWaitUntil:
    visible:
      id: "map-screen"
    timeout: 2000

# Toggle activities off then on
- tapOn:
    id: "map-toggle-activities"
    optional: true

- extendedWaitUntil:
    visible:
      id: "map-screen"
    timeout: 2000

- tapOn:
    id: "map-toggle-activities"
    optional: true

# Toggle heatmap (only available when data exists)
- tapOn:
    id: "map-toggle-heatmap"
    optional: true

# =============================================================================
# SECTION 6: Toggle Stress Test
# =============================================================================

# Toggle all layers rapidly to test for race conditions
# Use even number of repeats so toggles return to original state
- repeat:
    times: 4
    commands:
      - tapOn:
          id: "map-toggle-activities"
          optional: true
      - tapOn:
          id: "map-toggle-routes"
          optional: true
      - tapOn:
          id: "map-toggle-sections"
          optional: true

# =============================================================================
# SECTION 7: 3D Mode and Map Controls
# =============================================================================

# Toggle 3D mode on
- tapOn:
    id: "map-toggle-3d"
    optional: true

- extendedWaitUntil:
    visible:
      id: "map-screen"
    timeout: 2000

# Reset compass
- tapOn:
    id: "map-compass"
    optional: true

# Center on location
- tapOn:
    id: "map-location"
    optional: true

# Toggle 3D mode off
- tapOn:
    id: "map-toggle-3d"
    optional: true

# =============================================================================
# SECTION 8: Final State Validation
# =============================================================================

# Verify map is still responsive
- assertVisible:
    id: "map-screen"

# Tap activity marker one more time to verify everything still works
- tapOn:
    id: "map-activity-marker-demo-2026-01-14-0"
    optional: true

- extendedWaitUntil:
    visible:
      id: "activity-popup"
    timeout: 3000
    optional: true

# Close it
- tapOn:
    id: "activity-popup-close"
    optional: true

# Final verification
- assertVisible:
    id: "map-screen"

- takeScreenshot: "map-comprehensive-complete"
