# Comprehensive Map Integration Test
# Tests all map features: activities, routes, sections, popups, filters, and toggles
# Demo activity IDs use format: demo-YYYY-MM-DD-N (reference date: 2026-01-15)

appId: com.veloq.app
---
- launchApp

- extendedWaitUntil:
    visible:
      id: "login-screen"
    timeout: 30000

- tapOn:
    id: "login-demo-button"

- extendedWaitUntil:
    visible:
      id: "home-screen"
    timeout: 15000

# Navigate to map screen
- openLink: "veloq://map"

- extendedWaitUntil:
    visible:
      id: "map-screen"
    timeout: 15000

# Wait for map controls to load
- extendedWaitUntil:
    visible:
      id: "map-toggle-activities"
    timeout: 10000

# =============================================================================
# SECTION 1: Activity Markers
# =============================================================================

# Activities are ON by default, so we skip toggling here
# Just wait for markers to render
- extendedWaitUntil:
    visible:
      id: "map-toggle-activities"
    timeout: 3000

# Tap on first activity marker (try multiple dates in case some are rest days)
- tapOn:
    id: "map-activity-marker-demo-2026-01-14-0"
    optional: true

# Wait for popup to appear
- extendedWaitUntil:
    visible:
      id: "activity-popup"
    timeout: 3000
    optional: true

# Zoom to the activity
- tapOn:
    id: "activity-popup-zoom"
    optional: true

# Wait a moment for zoom animation
- extendedWaitUntil:
    visible:
      id: "activity-popup"
    timeout: 2000
    optional: true

# Close the popup
- tapOn:
    id: "activity-popup-close"
    optional: true

# Verify popup is closed
- extendedWaitUntil:
    notVisible:
      id: "activity-popup"
    timeout: 2000
    optional: true

# Reset map view by re-opening (zoom test left us zoomed in)
- openLink: "veloq://map"

- extendedWaitUntil:
    visible:
      id: "map-screen"
    timeout: 5000

# Wait for markers to render
- extendedWaitUntil:
    visible:
      id: "map-toggle-activities"
    timeout: 3000

# Tap another activity marker
- tapOn:
    id: "map-activity-marker-demo-2026-01-13-0"
    optional: true

- extendedWaitUntil:
    visible:
      id: "activity-popup"
    timeout: 3000
    optional: true

# View activity details
- tapOn:
    id: "activity-popup-view-details"
    optional: true

# Wait for activity detail screen to load
- extendedWaitUntil:
    visible:
      id: "activity-detail-screen"
    timeout: 10000
    optional: true

# Go back to map
- openLink: "veloq://map"

- extendedWaitUntil:
    visible:
      id: "map-screen"
    timeout: 10000

# Test multiple activity markers in sequence (reset map each time to ensure visibility)
- repeat:
    times: 3
    commands:
      # Reset map to default view
      - openLink: "veloq://map"
      - extendedWaitUntil:
          visible:
            id: "map-screen"
          timeout: 5000
      - extendedWaitUntil:
          visible:
            id: "map-toggle-activities"
          timeout: 3000
      # Tap first activity
      - tapOn:
          id: "map-activity-marker-demo-2026-01-12-0"
          optional: true
      - extendedWaitUntil:
          visible:
            id: "activity-popup"
          timeout: 2000
          optional: true
      - tapOn:
          id: "activity-popup-close"
          optional: true
      - extendedWaitUntil:
          notVisible:
            id: "activity-popup"
          timeout: 2000
          optional: true

# =============================================================================
# SECTION 2: Sport Type Filters
# =============================================================================

# Filter by Ride
- tapOn:
    id: "map-filter-ride"
    optional: true

# Wait for map to update
- extendedWaitUntil:
    visible:
      id: "map-screen"
    timeout: 2000

# Filter by Run
- tapOn:
    id: "map-filter-run"
    optional: true

- extendedWaitUntil:
    visible:
      id: "map-screen"
    timeout: 2000

# Filter by multiple types
- tapOn:
    id: "map-filter-swim"
    optional: true

- tapOn:
    id: "map-filter-hike"
    optional: true

# Clear all filters
- tapOn:
    id: "map-filter-clear"
    optional: true

# =============================================================================
# SECTION 3: Routes
# =============================================================================

# Enable routes layer
- tapOn:
    id: "map-toggle-routes"
    optional: true

# Wait for routes to load
- extendedWaitUntil:
    visible:
      id: "map-toggle-routes"
    timeout: 3000

# Try to tap on a route marker (route IDs are generated by the engine)
# We'll use a generic approach since route IDs aren't deterministic like activities
- tapOn:
    text: "Route"
    optional: true

# If route popup appears, interact with it
- extendedWaitUntil:
    visible:
      id: "route-popup"
    timeout: 3000
    optional: true

# View route details if popup appeared
- tapOn:
    id: "route-popup-view-details"
    optional: true

# Wait for route detail screen
- extendedWaitUntil:
    visible:
      id: "route-detail-screen"
    timeout: 5000
    optional: true

# Go back to map
- openLink: "veloq://map"

- extendedWaitUntil:
    visible:
      id: "map-screen"
    timeout: 10000

# =============================================================================
# SECTION 4: Sections
# =============================================================================

# Enable sections layer
- tapOn:
    id: "map-toggle-sections"
    optional: true

# Wait for sections to load
- extendedWaitUntil:
    visible:
      id: "map-toggle-sections"
    timeout: 3000

# Try to tap on a section marker (section IDs are generated by the engine)
- tapOn:
    text: "Section"
    optional: true

# If section popup appears, interact with it
- extendedWaitUntil:
    visible:
      id: "section-popup"
    timeout: 3000
    optional: true

# View section details if popup appeared
- tapOn:
    id: "section-popup-view-details"
    optional: true

# Wait for section detail screen
- extendedWaitUntil:
    visible:
      id: "section-detail-screen"
    timeout: 5000
    optional: true

# Go back to map
- openLink: "veloq://map"

- extendedWaitUntil:
    visible:
      id: "map-screen"
    timeout: 10000

# =============================================================================
# SECTION 5: Toggle Stress Test
# =============================================================================

# Toggle all layers rapidly to test for race conditions
# Use even number of repeats so toggles return to original state
- repeat:
    times: 4
    commands:
      - tapOn:
          id: "map-toggle-activities"
          optional: true
      - tapOn:
          id: "map-toggle-routes"
          optional: true
      - tapOn:
          id: "map-toggle-sections"
          optional: true
      - tapOn:
          id: "map-toggle-heatmap"
          optional: true

# =============================================================================
# SECTION 6: 3D Mode and Map Controls
# =============================================================================

# Toggle 3D mode
- tapOn:
    id: "map-toggle-3d"
    optional: true

# Wait for 3D transition
- extendedWaitUntil:
    visible:
      id: "map-screen"
    timeout: 2000

# Reset compass
- tapOn:
    id: "map-compass"
    optional: true

# Center on location
- tapOn:
    id: "map-location"
    optional: true

# Toggle 3D off
- tapOn:
    id: "map-toggle-3d"
    optional: true

# =============================================================================
# SECTION 7: Final State Validation
# =============================================================================

# Tap an activity one more time to verify everything still works
- tapOn:
    id: "map-activity-marker-demo-2026-01-10-0"
    optional: true

- extendedWaitUntil:
    visible:
      id: "activity-popup"
    timeout: 3000
    optional: true

# Close it
- tapOn:
    id: "activity-popup-close"
    optional: true

# Verify map is still responsive
- assertVisible:
    id: "map-screen"

- takeScreenshot: "map-comprehensive-complete"
