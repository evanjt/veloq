default_platform(:android)

***REMOVED***=
# Android Lanes
***REMOVED***=

platform :android do
  desc "Deploy AAB to Google Play Store"
  lane :deploy do |options|
    track = options[:track] || "internal"
    aab_path = options[:aab]

    UI.user_error!("No AAB file specified. Use aab:<path>") unless aab_path
    UI.user_error!("AAB file not found: #{aab_path}") unless File.exist?(aab_path)

    UI.message("Uploading #{aab_path} to #{track} track...")

    supply(
      track: track,
      aab: aab_path,
      skip_upload_metadata: false,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      release_status: track == "production" ? "completed" : "draft"
    )
  end

  desc "Promote from internal to beta track"
  lane :promote_to_beta do
    supply(
      track: "internal",
      track_promote_to: "beta",
      skip_upload_aab: true,
      skip_upload_metadata: true
    )
  end

  desc "Promote from beta to production (10% rollout)"
  lane :promote_to_production do
    supply(
      track: "beta",
      track_promote_to: "production",
      skip_upload_aab: true,
      skip_upload_metadata: true,
      rollout: "0.1"
    )
  end
end

***REMOVED***=
# iOS Lanes (requires Apple Developer account)
***REMOVED***=

platform :ios do
  desc "Sync certificates and provisioning profiles via Match"
  lane :certificates do
    match(type: "appstore", readonly: true)
  end

  desc "Build release IPA"
  lane :build_release do
    certificates

    # Get absolute paths (fastlane doesn't handle ../ well in some actions)
    project_root = File.expand_path("../..", __dir__)
    xcodeproj = File.join(project_root, "ios", "veloq.xcodeproj")
    xcworkspace = File.join(project_root, "ios", "veloq.xcworkspace")

    # Set team ID and code signing settings in Xcode project
    update_code_signing_settings(
      use_automatic_signing: false,
      path: xcodeproj,
      team_id: ENV["FASTLANE_TEAM_ID"],
      profile_name: "match AppStore com.veloq.app",
      code_sign_identity: "iPhone Distribution"
    )

    # Ensure artifacts directory exists for build logs
    FileUtils.mkdir_p("artifacts")

    build_app(
      workspace: xcworkspace,
      scheme: "Veloq",
      configuration: "Release",
      export_method: "app-store",
      output_directory: "artifacts",
      output_name: "veloq.ipa",
      clean: false,  # Don't clean - faster and avoids cache issues
      include_bitcode: false,
      buildlog_path: "artifacts",  # Save full xcodebuild log for debugging
      # NOTE: Don't use --keychain with ~ path - tilde doesn't expand in xcargs.
      # Match already configured certs in login.keychain, codesign will find them.
      # --timestamp=none prevents codesign from contacting Apple's timestamp servers
      # which can hang indefinitely in CI environments (especially with large XCFrameworks like MapLibre)
      xcargs: "-verbose OTHER_CODE_SIGN_FLAGS='--timestamp=none'"
    )
  end

  desc "Upload to TestFlight (internal track)"
  lane :beta do |options|
    ipa_path = options[:ipa] || "artifacts/veloq.ipa"

    UI.user_error!("No IPA file specified. Use ipa:<path>") unless ipa_path
    UI.user_error!("IPA file not found: #{ipa_path}") unless File.exist?(ipa_path)

    UI.message("Uploading #{ipa_path} to TestFlight...")

    api_key = app_store_connect_api_key(
      key_id: ENV["ASC_KEY_ID"],
      issuer_id: ENV["ASC_ISSUER_ID"],
      key_content: ENV["ASC_API_KEY"],
      is_key_content_base64: true
    )

    upload_to_testflight(
      api_key: api_key,
      ipa: ipa_path,
      skip_waiting_for_build_processing: true,
      distribute_external: false,
      notify_external_testers: false
    )
  end

  desc "Submit to App Store Review"
  lane :release do
    api_key = app_store_connect_api_key(
      key_id: ENV["ASC_KEY_ID"],
      issuer_id: ENV["ASC_ISSUER_ID"],
      key_content: ENV["ASC_API_KEY"],
      is_key_content_base64: true
    )

    deliver(
      api_key: api_key,
      submit_for_review: true,
      automatic_release: true,
      force: true,
      metadata_path: "fastlane/metadata/ios"
    )
  end
end
