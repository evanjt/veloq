name: Build iOS & Android

on:
  push:
    branches: [main]
    tags:
      - "[0-9]+.[0-9]+.[0-9]+"
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      build_type:
        description: "Build type override"
        required: false
        default: "auto"
        type: choice
        options:
          - auto
          - preview
          - production

env:
  NODE_VERSION: "20"

jobs:
  # ============================================
  # Parallel Tests (HIGH IMPACT: ~2-3 min faster)
  # ============================================
  test:
    name: Test (${{ matrix.name }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - name: typescript
            cmd: npx tsc --noEmit
          - name: format
            cmd: npm run format:check
          - name: jest
            cmd: npm test -- --maxWorkers=2
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "${{ env.NODE_VERSION }}"
          cache: "npm"

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            node-modules-${{ runner.os }}-

      - name: Install dependencies
        run: npm ci

      - name: Run ${{ matrix.name }}
        run: ${{ matrix.cmd }}

  # ============================================
  # Build Rust libraries for Android (parallel)
  # ============================================
  rust-build-android:
    name: Rust - Android ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: arm64-v8a
            rust_target: aarch64-linux-android
            abi: arm64-v8a
          - arch: armeabi-v7a
            rust_target: armv7-linux-androideabi
            abi: armeabi-v7a
          - arch: x86_64
            rust_target: x86_64-linux-android
            abi: x86_64
          - arch: x86
            rust_target: i686-linux-android
            abi: x86
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Rust Android target
        run: rustup target add ${{ matrix.rust_target }}

      - name: Install cargo-ndk
        run: cargo install cargo-ndk --quiet

      - name: Cache Rust build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: rust-android-${{ matrix.arch }}-${{ runner.os }}-${{ hashFiles('rust/route-matcher/Cargo.toml', 'rust/route-matcher/Cargo.lock', 'rust/route-matcher/**/*.rs') }}
          restore-keys: |
            rust-android-${{ matrix.arch }}-${{ runner.os }}-

      - name: Build Rust library for ${{ matrix.arch }}
        working-directory: rust/route-matcher
        run: |
          cargo ndk -t ${{ matrix.rust_target }} build --release --features full

      - name: Prepare artifact
        run: |
          mkdir -p artifact/${{ matrix.abi }}
          cp rust/route-matcher/target/${{ matrix.rust_target }}/release/libroute_matcher.so \
            artifact/${{ matrix.abi }}/libroute_matcher.so

      - name: Generate Kotlin bindings (arm64 only)
        if: matrix.arch == 'arm64-v8a'
        working-directory: rust/route-matcher
        run: |
          mkdir -p ../artifact
          cargo run --bin uniffi-bindgen --features ffi generate --library target/${{ matrix.rust_target }}/release/libroute_matcher.so \
            --language kotlin --out-dir ../artifact

      - name: Upload .so file
        uses: actions/upload-artifact@v4
        with:
          name: rust-android-${{ matrix.arch }}
          path: artifact/${{ matrix.abi }}/libroute_matcher.so
          retention-days: 1

      - name: Upload Kotlin bindings
        if: matrix.arch == 'arm64-v8a'
        uses: actions/upload-artifact@v4
        with:
          name: rust-android-kotlin-bindings
          path: artifact/*.kt
          retention-days: 1

  # ============================================
  # Build Android
  # ============================================
  build-android:
    name: Build Android APK
    needs: [test, rust-build-android]
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      version_code: ${{ steps.version.outputs.version_code }}
      short_sha: ${{ steps.version.outputs.short_sha }}
      filename: ${{ steps.version.outputs.filename }}
      is_release: ${{ steps.version.outputs.is_release }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version info
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)
          VERSION_CODE=$((MAJOR * 10000 + MINOR * 100 + PATCH))
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT

          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT

          BUILD_TYPE="preview"
          IS_RELEASE="false"

          if [[ "${{ inputs.build_type }}" != "" && "${{ inputs.build_type }}" != "auto" ]]; then
            BUILD_TYPE="${{ inputs.build_type }}"
          elif [[ "${{ github.ref_type }}" == "tag" ]]; then
            BUILD_TYPE="production"
            IS_RELEASE="true"
          fi

          echo "build_type=$BUILD_TYPE" >> $GITHUB_OUTPUT
          echo "is_release=$IS_RELEASE" >> $GITHUB_OUTPUT

          if [[ "$BUILD_TYPE" == "production" ]]; then
            echo "filename=veloq-${VERSION}" >> $GITHUB_OUTPUT
          else
            echo "filename=veloq-${VERSION}-${SHORT_SHA}" >> $GITHUB_OUTPUT
          fi

          echo "Build type: $BUILD_TYPE | Version: $VERSION ($VERSION_CODE)"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "${{ env.NODE_VERSION }}"
          cache: "npm"

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            node-modules-${{ runner.os }}-

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Cache Gradle dependencies and build outputs
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/.gradle/build-cache
            android/.gradle
            android/app/build
            android/build
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', 'android/**/*.java', 'android/**/*.kt', 'android/**/*.xml') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Install dependencies
        run: npm ci

      - name: Download Rust artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: rust-android-*
          path: artifacts/rust
          merge-multiple: true

      - name: Install Rust libraries to native module
        run: |
          # Copy downloaded .so files to jniLibs
          mkdir -p modules/route-matcher-native/android/src/main/jniLibs/{arm64-v8a,armeabi-v7a,x86_64,x86}
          cp artifacts/rust/arm64-v8a/libroute_matcher.so \
            modules/route-matcher-native/android/src/main/jniLibs/arm64-v8a/
          cp artifacts/rust/armeabi-v7a/libroute_matcher.so \
            modules/route-matcher-native/android/src/main/jniLibs/armeabi-v7a/
          cp artifacts/rust/x86_64/libroute_matcher.so \
            modules/route-matcher-native/android/src/main/jniLibs/x86_64/
          cp artifacts/rust/x86/libroute_matcher.so \
            modules/route-matcher-native/android/src/main/jniLibs/x86/

          # Copy Kotlin bindings
          mkdir -p modules/route-matcher-native/android/src/main/java/com/veloq/route
          cp artifacts/rust/RouteMatcher.kt \
            modules/route-matcher-native/android/src/main/java/com/veloq/route/RouteMatcher.kt

      - name: Cache Android prebuild
        id: android-prebuild-cache
        uses: actions/cache@v4
        with:
          path: android
          key: android-prebuild-${{ runner.os }}-${{ hashFiles('app.json', 'package.json', 'package-lock.json', 'plugins/**', 'expo-modules/**/*.json', 'modules/**/android/**', 'rust/route-matcher/Cargo.toml', 'rust/route-matcher/**/*.rs', 'node_modules/react-native-vector-icons/package.json', 'node_modules/react-native-webview/package.json') }}
          restore-keys: |
            android-prebuild-${{ runner.os }}-

      - name: Generate Android native project
        if: steps.android-prebuild-cache.outputs.cache-hit != 'true'
        run: npx expo prebuild --platform android

      # Setup signing AFTER prebuild creates android/ directory
      - name: Decode keystore
        id: keystore
        if: env.ANDROID_KEYSTORE_BASE64 != ''
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          mkdir -p android/app
          # Remove any whitespace/newlines from the secret
          CLEAN_KEYSTORE=$(echo "$ANDROID_KEYSTORE_BASE64" | tr -d ' \n\r\t')
          echo "$CLEAN_KEYSTORE" | base64 -d > android/app/release.keystore
          echo "signing_available=true" >> $GITHUB_OUTPUT

      - name: Create keystore.properties
        if: steps.keystore.outputs.signing_available == 'true'
        env:
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          cat > android/keystore.properties << EOF
          storeFile=release.keystore
          storePassword=$ANDROID_KEYSTORE_PASSWORD
          keyAlias=$ANDROID_KEY_ALIAS
          keyPassword=$ANDROID_KEY_PASSWORD
          EOF

      - name: Build Android APK
        run: |
          cd android && ./gradlew assembleRelease --no-daemon

      - name: Rename and copy APK
        run: |
          mkdir -p artifacts
          SUFFIX=""
          if [ ! -f android/keystore.properties ]; then
            SUFFIX="-unsigned"
            echo "⚠️ No signing configured - APK will be unsigned"
          else
            echo "✅ APK signed with release keystore"
          fi
          cp android/app/build/outputs/apk/release/app-release.apk \
            "artifacts/${{ steps.version.outputs.filename }}${SUFFIX}.apk"

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-${{ steps.version.outputs.filename }}
          path: artifacts/*.apk
          retention-days: 30

      - name: Build AAB for Play Store
        if: steps.version.outputs.is_release == 'true'
        run: |
          # Android folder and dependencies are already set up from APK build
          # Just run Gradle to build the AAB
          cd android && ./gradlew bundleRelease --no-daemon

      - name: Rename AAB
        if: steps.version.outputs.is_release == 'true'
        run: |
          AAB_PATH=$(find android/app/build/outputs/bundle -name "*.aab" | head -1)
          if [ -n "$AAB_PATH" ]; then
            cp "$AAB_PATH" "artifacts/${{ steps.version.outputs.filename }}.aab"
          fi

      - name: Upload AAB artifact
        if: steps.version.outputs.is_release == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: android-aab-${{ steps.version.outputs.filename }}
          path: artifacts/*.aab
          retention-days: 30

  # ============================================
  # Build iOS
  # ============================================
  build-ios:
    name: Build iOS App
    needs: test
    runs-on: macos-15
    outputs:
      version: ${{ steps.version.outputs.version }}
      version_code: ${{ steps.version.outputs.version_code }}
      short_sha: ${{ steps.version.outputs.short_sha }}
      filename: ${{ steps.version.outputs.filename }}
      is_release: ${{ steps.version.outputs.is_release }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version info
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)
          VERSION_CODE=$((MAJOR * 10000 + MINOR * 100 + PATCH))
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT

          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT

          BUILD_TYPE="preview"
          IS_RELEASE="false"

          if [[ "${{ inputs.build_type }}" != "" && "${{ inputs.build_type }}" != "auto" ]]; then
            BUILD_TYPE="${{ inputs.build_type }}"
          elif [[ "${{ github.ref_type }}" == "tag" ]]; then
            BUILD_TYPE="production"
            IS_RELEASE="true"
          fi

          echo "build_type=$BUILD_TYPE" >> $GITHUB_OUTPUT
          echo "is_release=$IS_RELEASE" >> $GITHUB_OUTPUT

          if [[ "$BUILD_TYPE" == "production" ]]; then
            echo "filename=veloq-${VERSION}" >> $GITHUB_OUTPUT
          else
            echo "filename=veloq-${VERSION}-${SHORT_SHA}" >> $GITHUB_OUTPUT
          fi

          echo "Build type: $BUILD_TYPE | Version: $VERSION ($VERSION_CODE)"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "${{ env.NODE_VERSION }}"
          cache: "npm"

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node-modules-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            node-modules-${{ runner.os }}-

      # ============================================
      # Rust Build
      # ============================================
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Rust iOS targets
        run: rustup target add aarch64-apple-ios aarch64-apple-ios-sim x86_64-apple-ios

      - name: Cache Rust build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            rust/route-matcher/target/ios
            rust/route-matcher/target/release
          key: rust-ios-${{ runner.os }}-${{ hashFiles('rust/route-matcher/Cargo.toml', 'rust/route-matcher/Cargo.lock', 'rust/route-matcher/**/*.rs') }}
          restore-keys: |
            rust-ios-${{ runner.os }}-

      - name: Build Rust library for iOS
        run: |
          cd rust/route-matcher
          ./scripts/build-ios.sh

      # Removed redundant verification steps (MEDIUM IMPACT)

      - name: Install Rust library to native module
        run: |
          cd rust/route-matcher
          ./scripts/install-ios.sh

      - name: Save Rust build cache
        uses: actions/cache/save@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            rust/route-matcher/target/ios
            rust/route-matcher/target/release
          key: rust-ios-${{ runner.os }}-${{ hashFiles('rust/route-matcher/Cargo.toml', 'rust/route-matcher/Cargo.lock', 'rust/route-matcher/**/*.rs') }}

      - name: Cache iOS prebuild
        id: ios-prebuild-cache
        uses: actions/cache@v4
        with:
          path: ios
          key: ios-prebuild-${{ runner.os }}-${{ hashFiles('app.json', 'package.json', 'plugins/**', 'expo-modules/**/*.json', 'modules/**/ios/**', 'rust/route-matcher/Cargo.toml', 'rust/route-matcher/**/*.rs') }}
          restore-keys: |
            ios-prebuild-${{ runner.os }}-

      # ============================================
      # iOS Build
      # ============================================
      - name: Install dependencies
        run: npm ci

      - name: Generate native project
        if: steps.ios-prebuild-cache.outputs.cache-hit != 'true'
        run: npx expo prebuild --platform ios

      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: |
            ios/Pods
            ~/Library/Caches/CocoaPods
          key: cocoapods-${{ runner.os }}-${{ hashFiles('ios/Podfile.lock') }}
          restore-keys: |
            cocoapods-${{ runner.os }}-

      - name: Setup Ruby & Install CocoaPods
        if: steps.ios-prebuild-cache.outputs.cache-hit != 'true'
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"
          bundler-cache: true

      - name: Install Pods
        if: steps.ios-prebuild-cache.outputs.cache-hit != 'true'
        working-directory: ios
        run: pod install

      - name: Build iOS Simulator app
        run: |
          xcodebuild -workspace ios/veloq.xcworkspace \
            -scheme Veloq \
            -configuration Release \
            -sdk iphonesimulator \
            -arch x86_64 \
            -derivedDataPath ios/build \
            CODE_SIGNING_ALLOWED=NO \
            2>&1 | tee build.log || (echo "=== Build failed, showing last 100 lines ===" && tail -100 build.log && exit 1)

      - name: Package .app
        run: |
          mkdir -p artifacts
          APP_PATH=$(find ios/build/Build/Products/Release-iphonesimulator -name "*.app" -type d | head -1)
          if [ -n "$APP_PATH" ]; then
            cd "$(dirname "$APP_PATH")"
            zip -r "$GITHUB_WORKSPACE/artifacts/${{ steps.version.outputs.filename }}-ios-simulator.zip" "$(basename "$APP_PATH")"
          else
            echo "ERROR: No .app found!"
            find ios/build -name "*.app" -type d
            exit 1
          fi

      - name: Upload iOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-simulator-${{ steps.version.outputs.filename }}
          path: artifacts/*-ios-simulator.zip
          retention-days: 30

      - name: Upload Rust build artifacts (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: rust-ios-build-artifacts
          path: |
            rust/route-matcher/target/ios/
            modules/route-matcher-native/ios/Frameworks/
            modules/route-matcher-native/ios/Generated/
          retention-days: 7

  # ============================================
  # Create Release (only on tags)
  # ============================================
  release:
    name: Create Release
    if: needs.build-android.outputs.is_release == 'true'
    needs: [build-android, build-ios]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Android APK artifact
        uses: actions/download-artifact@v4
        with:
          name: android-apk-${{ needs.build-android.outputs.filename }}
          path: artifacts/

      - name: Download Android AAB artifact
        uses: actions/download-artifact@v4
        with:
          name: android-aab-${{ needs.build-android.outputs.filename }}
          path: artifacts/

      - name: Download iOS artifact
        uses: actions/download-artifact@v4
        with:
          name: ios-simulator-${{ needs.build-ios.outputs.filename }}
          path: artifacts/

      - name: Generate release notes
        id: notes
        run: |
          VERSION="${{ needs.build-android.outputs.version }}"
          CHANGELOG_FILE="fastlane/metadata/android/en-US/changelogs/${{ needs.build-android.outputs.version_code }}.txt"

          if [ -f "$CHANGELOG_FILE" ]; then
            CHANGELOG=$(cat "$CHANGELOG_FILE")
          else
            CHANGELOG="See commit history for changes."
          fi

          cat > release-notes.md << EOF
          # Veloq v${VERSION}

          ## What's New

          $CHANGELOG

          ## Downloads

          - **Android APK:** \`${{ needs.build-android.outputs.filename }}.apk\` (direct install)
          - **Android AAB:** \`${{ needs.build-android.outputs.filename }}.aab\` (Play Store format)
          - **iOS Simulator:** \`${{ needs.build-ios.outputs.filename }}-ios-simulator.zip\`

          ## Installation

          ### Android
          Download the APK and install directly on your device. You may need to enable "Install from unknown sources" in your device settings.

          ### iOS Simulator
          Unzip and drag the .app file onto the iOS Simulator.

          ---

          Built from commit: ${{ github.sha }}
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Veloq v${{ needs.build-android.outputs.version }}
          tag_name: ${{ github.ref_name }}
          body_path: release-notes.md
          files: |
            artifacts/*.apk
            artifacts/*.aab
            artifacts/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
