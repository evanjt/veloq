name: Build & Test Simulator Apps

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_e2e:
        description: 'Skip E2E tests'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: "20"

jobs:
  # ============================================
  # Detect changes to skip unnecessary builds
  # ============================================
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      ios: ${{ steps.filter.outputs.ios }}
      android: ${{ steps.filter.outputs.android }}
      source_hash: ${{ steps.hash.outputs.source_hash }}
    steps:
      - uses: actions/checkout@v4

      - name: Check for changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            ios:
              - 'src/**'
              - 'app/**'
              - 'app.json'
              - 'package.json'
              - 'plugins/**'
            android:
              - 'src/**'
              - 'app/**'
              - 'app.json'
              - 'package.json'
              - 'plugins/**'

      - name: Calculate source hash
        id: hash
        run: |
          # Include all files that affect the build (modules are under src/)
          HASH=$(cat <(find src app plugins .github -type f \( -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.json" -o -name "*.gradle" \) -exec sha256sum {} \; 2>/dev/null) <(sha256sum package.json app.json 2>/dev/null) | sort | sha256sum | cut -d' ' -f1 | head -c 12)
          echo "source_hash=$HASH" >> $GITHUB_OUTPUT

  # ============================================
  # iOS Simulator Builds (always runs, uses cache to skip compilation)
  # ============================================
  ios-simulator:
    needs: changes
    name: iOS ${{ matrix.config }}
    runs-on: macos-26
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        config: [Debug, Release]
    outputs:
      artifact_name: ${{ steps.version.outputs.artifact_name }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '26.2'

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - run: npm ci

      - name: Get version info
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          SHORT_SHA=$(git rev-parse --short HEAD)
          CONFIG_LOWER=$(echo "${{ matrix.config }}" | tr '[:upper:]' '[:lower:]')
          # Include all files that affect the build: src, app, modules (JS + native code), plugins
          SOURCE_HASH=$(cat <(find src app modules plugins -type f \( -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.json" -o -name "*.swift" -o -name "*.m" -o -name "*.mm" -o -name "*.h" -o -name "*.kt" -o -name "*.java" -o -name "*.podspec" \) -exec sha256sum {} \; 2>/dev/null) <(sha256sum package.json app.json 2>/dev/null) | sort | sha256sum | cut -d' ' -f1 | head -c 12)

          echo "artifact_name=ios-${{ matrix.config }}-${SOURCE_HASH}" >> $GITHUB_OUTPUT
          echo "filename=veloq-${VERSION}-${SHORT_SHA}-simulator-${CONFIG_LOWER}" >> $GITHUB_OUTPUT
          echo "source_hash=$SOURCE_HASH" >> $GITHUB_OUTPUT

      - name: Cache built iOS app
        id: app-cache
        uses: actions/cache@v4
        with:
          path: ios/build/Build/Products/${{ matrix.config }}-iphonesimulator/Veloq.app
          # v11: Xcode 26.2 on macOS 26
          key: ios-app-v11-${{ matrix.config }}-${{ steps.version.outputs.source_hash }}

      # Download tracematch BEFORE prebuild since expo prebuild runs pod install
      # which requires the Generated folder with modulemap to exist
      - name: Download tracematch XCFramework
        if: steps.app-cache.outputs.cache-hit != 'true'
        run: |
          TRACEMATCH_VERSION=$(node -p "require('./package.json').tracematchVersion")
          RELEASE_URL="https://github.com/evanjt/route-matcher/releases/download/${TRACEMATCH_VERSION}"
          curl -sL "${RELEASE_URL}/tracematch-ios-${TRACEMATCH_VERSION}.zip" -o /tmp/ios.zip
          unzip -q /tmp/ios.zip -d /tmp/tracematch

          # Install XCFramework (rename to match podspec: TracematchFFI.xcframework)
          mkdir -p src/modules/route-matcher-native/ios/Frameworks
          cp -r /tmp/tracematch/ios/RouteMatcherFFI.xcframework \
                src/modules/route-matcher-native/ios/Frameworks/TracematchFFI.xcframework

          # Install Swift bindings and headers
          mkdir -p src/modules/route-matcher-native/ios/Generated
          cp /tmp/tracematch/ios/Generated/tracematch.swift \
             src/modules/route-matcher-native/ios/Generated/
          cp /tmp/tracematch/ios/Generated/tracematchFFI.h \
             src/modules/route-matcher-native/ios/Generated/
          cp /tmp/tracematch/ios/Generated/tracematchFFI.modulemap \
             src/modules/route-matcher-native/ios/Generated/

          echo "✓ Installed iOS XCFramework and Swift bindings"

          # Copy C++ files into module ios/cpp/ where CocoaPods can find them
          # (TypeScript/C++ bindings are committed to repo)
          mkdir -p src/modules/route-matcher-native/ios/cpp
          cp src/modules/route-matcher-native/cpp/veloq.h src/modules/route-matcher-native/ios/cpp/
          cp src/modules/route-matcher-native/cpp/veloq.cpp src/modules/route-matcher-native/ios/cpp/
          cp src/modules/route-matcher-native/cpp/tracematch.hpp src/modules/route-matcher-native/ios/cpp/
          cp src/modules/route-matcher-native/cpp/tracematch.cpp src/modules/route-matcher-native/ios/cpp/
          echo "✓ Copied C++ files to module ios/cpp/"

      - name: Cache iOS prebuild
        if: steps.app-cache.outputs.cache-hit != 'true'
        id: ios-prebuild-cache
        uses: actions/cache@v4
        with:
          path: ios
          # v11: Xcode 26.2 on macOS 26
          key: ios-sim-prebuild-v11-${{ runner.os }}-${{ hashFiles('app.json', 'package.json', 'package-lock.json', 'plugins/**', 'src/modules/**/ios/**', 'src/modules/**/package.json') }}
          restore-keys: ios-sim-prebuild-v10-${{ runner.os }}-

      - name: Expo Prebuild
        if: steps.app-cache.outputs.cache-hit != 'true' && steps.ios-prebuild-cache.outputs.cache-hit != 'true'
        run: npx expo prebuild --platform ios --clean

      - name: Cache CocoaPods
        if: steps.app-cache.outputs.cache-hit != 'true'
        uses: actions/cache@v4
        with:
          path: |
            ios/Pods
            ~/Library/Caches/CocoaPods
          # v9: Xcode 26.2 on macOS 26
          key: pods-sim-v9-${{ runner.os }}-${{ hashFiles('ios/Podfile.lock') }}
          restore-keys: pods-sim-v8-${{ runner.os }}-

      - name: Install CocoaPods
        if: steps.app-cache.outputs.cache-hit != 'true'
        run: |
          gem install cocoapods
          cd ios && pod install

      - name: Initialize simulator
        if: steps.app-cache.outputs.cache-hit != 'true'
        run: |
          xcrun simctl list > /dev/null 2>&1 || true
          if ! xcrun simctl list devices available | grep -q "iPhone"; then
            xcodebuild -downloadPlatform iOS || exit 1
          fi

      - name: Find simulator
        if: steps.app-cache.outputs.cache-hit != 'true'
        id: simulator
        run: |
          # Use iPhone 17 for build (Xcode 26.x)
          DEVICE_UDID=$(xcrun simctl list devices available | grep -E "iPhone 17 \(" | head -1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/')
          if [ -z "$DEVICE_UDID" ]; then
            # Fallback to any available iPhone
            DEVICE_UDID=$(xcrun simctl list devices available | grep -E "iPhone" | head -1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/')
          fi
          echo "Found simulator UDID: $DEVICE_UDID"
          xcrun simctl boot "$DEVICE_UDID" || true
          echo "udid=$DEVICE_UDID" >> $GITHUB_OUTPUT

      - name: Build iOS App
        if: steps.app-cache.outputs.cache-hit != 'true'
        run: |
          xcodebuild -workspace ios/Veloq.xcworkspace \
            -scheme Veloq \
            -configuration ${{ matrix.config }} \
            -sdk iphonesimulator \
            -destination "id=${{ steps.simulator.outputs.udid }}" \
            -derivedDataPath ios/build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            2>&1 | tee ios-build.log || {
              tail -100 ios-build.log
              exit 1
            }

      - name: Skip build (cache hit)
        if: steps.app-cache.outputs.cache-hit == 'true'
        run: echo "✓ Using cached iOS app (hash ${{ steps.version.outputs.source_hash }})"

      - name: Verify and package build
        run: |
          APP_PATH="ios/build/Build/Products/${{ matrix.config }}-iphonesimulator/Veloq.app"
          if [ ! -d "$APP_PATH" ]; then
            echo "ERROR: App not found"
            exit 1
          fi
          # Verify executable exists
          if [ ! -f "$APP_PATH/Veloq" ]; then
            echo "ERROR: Missing executable at $APP_PATH/Veloq"
            ls -la "$APP_PATH/"
            exit 1
          fi
          echo "App size: $(du -sh "$APP_PATH" | cut -f1)"
          echo "Executable: $(ls -la "$APP_PATH/Veloq")"
          # Zip with -y to preserve symlinks
          cd "$(dirname "$APP_PATH")"
          zip -yr Veloq.app.zip Veloq.app
          echo "Created Veloq.app.zip ($(du -sh Veloq.app.zip | cut -f1))"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.version.outputs.artifact_name }}
          path: ios/build/Build/Products/${{ matrix.config }}-iphonesimulator/Veloq.app.zip
          retention-days: 7

      - name: Upload build log on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ios-${{ matrix.config }}-build-log
          path: ios-build.log
          retention-days: 3

  # ============================================
  # Android Build (Release for E2E - has JS bundle embedded)
  # ============================================
  android-release:
    needs: changes
    name: Android Release
    runs-on: ubuntu-latest
    timeout-minutes: 60
    outputs:
      artifact_name: ${{ steps.version.outputs.artifact_name }}
    env:
      JAVA_TOOL_OPTIONS: "-Dhttp.agent=Gradle -Dhttps.agent=Gradle"
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - uses: android-actions/setup-android@v3

      - uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      - run: npm ci

      - name: Get version info
        id: version
        run: |
          # Include all files that affect the build: src, app, modules (JS + native), plugins
          SOURCE_HASH=$(cat <(find src app modules plugins -type f \( -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.json" -o -name "*.swift" -o -name "*.m" -o -name "*.mm" -o -name "*.h" -o -name "*.kt" -o -name "*.java" -o -name "*.podspec" -o -name "*.gradle" \) -exec sha256sum {} \; 2>/dev/null) <(sha256sum package.json app.json 2>/dev/null) | sort | sha256sum | cut -d' ' -f1 | head -c 12)
          echo "artifact_name=android-release-${SOURCE_HASH}" >> $GITHUB_OUTPUT
          echo "source_hash=$SOURCE_HASH" >> $GITHUB_OUTPUT

      - name: Cache built APKs
        id: apk-cache
        uses: actions/cache@v4
        with:
          path: |
            android/app/build/outputs/apk/release/app-release.apk
            android/app/build/outputs/apk/androidTest/release/app-release-androidTest.apk
          # v5: bindings now generated from crates.io source
          key: android-release-apk-v5-${{ steps.version.outputs.source_hash }}

      - name: Cache Android prebuild
        if: steps.apk-cache.outputs.cache-hit != 'true'
        id: android-prebuild-cache
        uses: actions/cache@v4
        with:
          path: android
          # v4: fix path to src/modules
          key: android-release-prebuild-v4-${{ runner.os }}-${{ hashFiles('app.json', 'package.json', 'src/modules/**/android/**', 'src/modules/**/package.json') }}

      - name: Expo Prebuild
        if: steps.apk-cache.outputs.cache-hit != 'true' && steps.android-prebuild-cache.outputs.cache-hit != 'true'
        run: npx expo prebuild --platform android --clean

      - name: Download tracematch binaries
        if: steps.apk-cache.outputs.cache-hit != 'true'
        run: |
          TRACEMATCH_VERSION=$(node -p "require('./package.json').tracematchVersion")
          RELEASE_URL="https://github.com/evanjt/route-matcher/releases/download/${TRACEMATCH_VERSION}"
          curl -sL "${RELEASE_URL}/tracematch-android-${TRACEMATCH_VERSION}.zip" -o /tmp/android.zip
          unzip -q /tmp/android.zip -d /tmp/tracematch
          mkdir -p src/modules/route-matcher-native/android/src/main/jniLibs
          for arch in arm64-v8a armeabi-v7a x86_64 x86; do
            mkdir -p "src/modules/route-matcher-native/android/src/main/jniLibs/$arch"
            cp "/tmp/tracematch/android/jniLibs/$arch/libtracematch.so" "src/modules/route-matcher-native/android/src/main/jniLibs/$arch/"
          done
          # NOTE: We do NOT install tracematch.kt from the release (that's JNA-based, JVM-only).
          # The repo has committed VeloqModule.kt (JNI-based) which is the correct TurboModule wrapper.
          # TypeScript/C++ bindings are already committed to the repo.

      - name: Install Gradle init script
        if: steps.apk-cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p ~/.gradle
          cp .github/ci-init.gradle ~/.gradle/init.gradle

      - name: Free disk space
        if: steps.apk-cache.outputs.cache-hit != 'true'
        run: |
          sudo rm -rf /usr/local/lib/android/sdk/ndk
          sudo rm -rf /usr/local/lib/android/sdk/build-tools/3[0-3]*
          sudo rm -rf /usr/local/lib/android/sdk/platforms/android-[1-2]*
          sudo rm -rf /usr/local/lib/android/sdk/platforms/android-3[0-2]
          sudo docker image prune --all --force || true
          df -h

      - name: Build Release APKs
        if: steps.apk-cache.outputs.cache-hit != 'true'
        env:
          RUST_PREBUILT: "true"
        run: |
          # Only build arm64-v8a (modern devices) and x86_64 (emulator) to save disk space
          cd android && ./gradlew assembleRelease assembleAndroidTest \
            -PreactNativeArchitectures=arm64-v8a,x86_64 \
            -DtestBuildType=release --no-daemon

      - name: Skip build (cache hit)
        if: steps.apk-cache.outputs.cache-hit == 'true'
        run: echo "✓ Using cached APKs (hash ${{ steps.version.outputs.source_hash }})"

      - name: Upload APKs
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.version.outputs.artifact_name }}
          path: |
            android/app/build/outputs/apk/release/app-release.apk
            android/app/build/outputs/apk/androidTest/release/app-release-androidTest.apk
          retention-days: 7

  # ============================================
  # Screenshots - iOS (PRIMARY - must succeed)
  # ============================================
  screenshots-ios:
    needs: ios-simulator
    if: ${{ !inputs.skip_e2e }}
    name: Screenshots iOS
    runs-on: macos-26
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - run: npm ci

      - name: Get artifact name
        id: artifact
        run: |
          SOURCE_HASH=$(cat <(find src app modules plugins -type f \( -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.json" -o -name "*.swift" -o -name "*.m" -o -name "*.mm" -o -name "*.h" -o -name "*.kt" -o -name "*.java" -o -name "*.podspec" \) -exec sha256sum {} \; 2>/dev/null) <(sha256sum package.json app.json 2>/dev/null) | sort | sha256sum | cut -d' ' -f1 | head -c 12)
          echo "name=ios-Release-${SOURCE_HASH}" >> $GITHUB_OUTPUT

      - name: Download iOS app
        uses: actions/download-artifact@v4
        with:
          name: ${{ steps.artifact.outputs.name }}
          path: /tmp/ios-artifact

      - name: Extract iOS app
        run: |
          mkdir -p ios/build/Build/Products/Release-iphonesimulator
          unzip /tmp/ios-artifact/Veloq.app.zip -d ios/build/Build/Products/Release-iphonesimulator/

      - name: Install applesimutils
        run: |
          brew tap wix/brew
          brew install applesimutils

      - name: Find 6.9" iPhone simulator
        id: simulator
        run: |
          # Use iPhone 17 Pro Max for 6.9" screenshots (Xcode 26.x)
          DEVICE="iPhone 17 Pro Max"
          echo "device=$DEVICE" >> $GITHUB_OUTPUT
          echo "Using 6.9\" iPhone simulator: $DEVICE"

      - name: Capture Screenshots
        env:
          DETOX_DEVICE_TYPE: ${{ steps.simulator.outputs.device }}
        run: |
          npx detox test --configuration ios.sim.release --headless \
            --testPathPattern "screenshots" \
            --record-logs all --loglevel verbose

      - name: Collect and flatten screenshots
        if: always()
        run: |
          mkdir -p screenshots-flat
          # Find all screenshot PNGs (exclude diagnostic images like DETOX_VISIBILITY_*)
          find artifacts -name "*.png" ! -name "DETOX_*" ! -name "testDone.png" ! -name "testFnFailure.png" -exec cp {} screenshots-flat/ \;
          # Rename to include platform suffix
          cd screenshots-flat
          for f in *.png; do
            [ -f "$f" ] && mv "$f" "${f%.png}-ios.png" 2>/dev/null || true
          done
          ls -la screenshots-flat/ || true

      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-ios
          path: screenshots-flat/
          retention-days: 14

  # ============================================
  # Screenshots - iPad (PRIMARY - must succeed)
  # ============================================
  screenshots-ipad:
    needs: ios-simulator
    if: ${{ !inputs.skip_e2e }}
    name: Screenshots iPad
    runs-on: macos-26
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - run: npm ci

      - name: Get artifact name
        id: artifact
        run: |
          SOURCE_HASH=$(cat <(find src app modules plugins -type f \( -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.json" -o -name "*.swift" -o -name "*.m" -o -name "*.mm" -o -name "*.h" -o -name "*.kt" -o -name "*.java" -o -name "*.podspec" \) -exec sha256sum {} \; 2>/dev/null) <(sha256sum package.json app.json 2>/dev/null) | sort | sha256sum | cut -d' ' -f1 | head -c 12)
          echo "name=ios-Release-${SOURCE_HASH}" >> $GITHUB_OUTPUT

      - name: Download iOS app
        uses: actions/download-artifact@v4
        with:
          name: ${{ steps.artifact.outputs.name }}
          path: /tmp/ios-artifact

      - name: Extract iOS app
        run: |
          mkdir -p ios/build/Build/Products/Release-iphonesimulator
          unzip /tmp/ios-artifact/Veloq.app.zip -d ios/build/Build/Products/Release-iphonesimulator/

      - name: Install applesimutils
        run: |
          brew tap wix/brew
          brew install applesimutils

      - name: Find 13" iPad simulator
        id: simulator
        run: |
          # Use iPad Pro 13-inch (M5) for 13" screenshots (Xcode 26.x)
          DEVICE="iPad Pro 13-inch (M5)"
          echo "device=$DEVICE" >> $GITHUB_OUTPUT
          echo "Using 13\" iPad simulator: $DEVICE"

      - name: Capture Screenshots
        env:
          DETOX_DEVICE_TYPE: ${{ steps.simulator.outputs.device }}
        run: |
          npx detox test --configuration ios.sim.release --headless \
            --testPathPattern "screenshots" \
            --record-logs all --loglevel verbose

      - name: Collect and flatten screenshots
        if: always()
        run: |
          mkdir -p screenshots-flat
          find artifacts -name "*.png" ! -name "DETOX_*" ! -name "testDone.png" ! -name "testFnFailure.png" -exec cp {} screenshots-flat/ \;
          cd screenshots-flat
          for f in *.png; do
            [ -f "$f" ] && mv "$f" "${f%.png}-ipad.png" 2>/dev/null || true
          done
          ls -la screenshots-flat/ || true

      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-ipad
          path: screenshots-flat/
          retention-days: 14

  # ============================================
  # E2E Functional Tests - iOS (SECONDARY - failures don't block)
  # ============================================
  e2e-ios-functional:
    needs: ios-simulator
    if: ${{ !inputs.skip_e2e }}
    name: E2E iOS (optional)
    runs-on: macos-26
    timeout-minutes: 30
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - run: npm ci

      - name: Get artifact name
        id: artifact
        run: |
          SOURCE_HASH=$(cat <(find src app modules plugins -type f \( -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.json" -o -name "*.swift" -o -name "*.m" -o -name "*.mm" -o -name "*.h" -o -name "*.kt" -o -name "*.java" -o -name "*.podspec" \) -exec sha256sum {} \; 2>/dev/null) <(sha256sum package.json app.json 2>/dev/null) | sort | sha256sum | cut -d' ' -f1 | head -c 12)
          echo "name=ios-Release-${SOURCE_HASH}" >> $GITHUB_OUTPUT

      - name: Download iOS app
        uses: actions/download-artifact@v4
        with:
          name: ${{ steps.artifact.outputs.name }}
          path: /tmp/ios-artifact

      - name: Extract iOS app
        run: |
          mkdir -p ios/build/Build/Products/Release-iphonesimulator
          unzip /tmp/ios-artifact/Veloq.app.zip -d ios/build/Build/Products/Release-iphonesimulator/

      - name: Install applesimutils
        run: |
          brew tap wix/brew
          brew install applesimutils

      - name: Find 6.9" iPhone simulator
        id: simulator
        run: |
          # Use iPhone 17 Pro Max for functional tests (Xcode 26.x)
          DEVICE="iPhone 17 Pro Max"
          echo "device=$DEVICE" >> $GITHUB_OUTPUT

      - name: Run Functional Tests
        env:
          DETOX_DEVICE_TYPE: ${{ steps.simulator.outputs.device }}
        run: |
          npx detox test --configuration ios.sim.release --headless \
            --testPathPattern 'demo-mode|navigation' \
            --record-logs all --loglevel verbose

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-ios-functional-results
          path: artifacts/
          retention-days: 7

  # ============================================
  # Screenshots - Android (PRIMARY - must succeed)
  # ============================================
  screenshots-android:
    needs: android-release
    if: ${{ !inputs.skip_e2e }}
    name: Screenshots Android
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - uses: android-actions/setup-android@v3

      - run: npm ci

      - name: Get artifact name
        id: artifact
        run: |
          SOURCE_HASH=$(cat <(find src app modules plugins -type f \( -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.json" -o -name "*.swift" -o -name "*.m" -o -name "*.mm" -o -name "*.h" -o -name "*.kt" -o -name "*.java" -o -name "*.podspec" -o -name "*.gradle" \) -exec sha256sum {} \; 2>/dev/null) <(sha256sum package.json app.json 2>/dev/null) | sort | sha256sum | cut -d' ' -f1 | head -c 12)
          echo "name=android-release-${SOURCE_HASH}" >> $GITHUB_OUTPUT

      - name: Download APKs
        uses: actions/download-artifact@v4
        with:
          name: ${{ steps.artifact.outputs.name }}
          path: android/app/build/outputs/apk

      - name: Organize APKs
        run: |
          mkdir -p android/app/build/outputs/apk/release
          mkdir -p android/app/build/outputs/apk/androidTest/release
          if [ -f android/app/build/outputs/apk/app-release.apk ]; then
            mv android/app/build/outputs/apk/app-release.apk android/app/build/outputs/apk/release/
          fi
          if [ -f android/app/build/outputs/apk/app-release-androidTest.apk ]; then
            mv android/app/build/outputs/apk/app-release-androidTest.apk android/app/build/outputs/apk/androidTest/release/
          fi

      - name: Free disk space
        run: |
          sudo rm -rf /usr/local/lib/android/sdk/ndk
          sudo rm -rf /usr/local/lib/android/sdk/build-tools/3[0-3]*
          sudo rm -rf /usr/local/lib/android/sdk/platforms/android-[1-2]*
          sudo rm -rf /usr/local/lib/android/sdk/platforms/android-3[0-2]
          sudo docker image prune --all --force || true

      - name: Create AVD
        run: |
          echo "y" | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "system-images;android-30;default;x86_64"
          echo "no" | $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager create avd \
            -n Pixel_5_API_30 \
            -k "system-images;android-30;default;x86_64" \
            --device "pixel_5" \
            --force

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Capture Screenshots
        uses: reactivecircus/android-emulator-runner@v2
        env:
          DETOX_DEVICE_AVD_NAME: Pixel_5_API_30
        with:
          api-level: 30
          target: default
          arch: x86_64
          avd-name: Pixel_5_API_30
          emulator-boot-timeout: 600
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -accel on
          disable-animations: true
          script: |
            adb wait-for-device
            adb shell settings put global window_animation_scale 0
            adb shell settings put global transition_animation_scale 0
            adb shell settings put global animator_duration_scale 0
            DETOX_DEVICE_AVD_NAME=Pixel_5_API_30 npx detox test --configuration android.emu.release --headless --testPathPattern screenshots --record-logs all --loglevel verbose

      - name: Collect and flatten screenshots
        if: always()
        run: |
          mkdir -p screenshots-flat
          find artifacts -name "*.png" ! -name "DETOX_*" ! -name "testDone.png" ! -name "testFnFailure.png" -exec cp {} screenshots-flat/ \;
          cd screenshots-flat
          for f in *.png; do
            [ -f "$f" ] && mv "$f" "${f%.png}-android.png" 2>/dev/null || true
          done
          ls -la screenshots-flat/ || true

      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-android
          path: screenshots-flat/
          retention-days: 14

  # ============================================
  # E2E Functional Tests - Android (SECONDARY - failures don't block)
  # ============================================
  e2e-android-functional:
    needs: android-release
    if: ${{ !inputs.skip_e2e }}
    name: E2E Android (optional)
    runs-on: ubuntu-latest
    timeout-minutes: 45
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - uses: android-actions/setup-android@v3

      - run: npm ci

      - name: Get artifact name
        id: artifact
        run: |
          SOURCE_HASH=$(cat <(find src app modules plugins -type f \( -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.json" -o -name "*.swift" -o -name "*.m" -o -name "*.mm" -o -name "*.h" -o -name "*.kt" -o -name "*.java" -o -name "*.podspec" -o -name "*.gradle" \) -exec sha256sum {} \; 2>/dev/null) <(sha256sum package.json app.json 2>/dev/null) | sort | sha256sum | cut -d' ' -f1 | head -c 12)
          echo "name=android-release-${SOURCE_HASH}" >> $GITHUB_OUTPUT

      - name: Download APKs
        uses: actions/download-artifact@v4
        with:
          name: ${{ steps.artifact.outputs.name }}
          path: android/app/build/outputs/apk

      - name: Organize APKs
        run: |
          mkdir -p android/app/build/outputs/apk/release
          mkdir -p android/app/build/outputs/apk/androidTest/release
          if [ -f android/app/build/outputs/apk/app-release.apk ]; then
            mv android/app/build/outputs/apk/app-release.apk android/app/build/outputs/apk/release/
          fi
          if [ -f android/app/build/outputs/apk/app-release-androidTest.apk ]; then
            mv android/app/build/outputs/apk/app-release-androidTest.apk android/app/build/outputs/apk/androidTest/release/
          fi

      - name: Free disk space
        run: |
          sudo rm -rf /usr/local/lib/android/sdk/ndk
          sudo rm -rf /usr/local/lib/android/sdk/build-tools/3[0-3]*
          sudo rm -rf /usr/local/lib/android/sdk/platforms/android-[1-2]*
          sudo rm -rf /usr/local/lib/android/sdk/platforms/android-3[0-2]
          sudo docker image prune --all --force || true

      - name: Create AVD
        run: |
          echo "y" | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "system-images;android-30;default;x86_64"
          echo "no" | $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager create avd \
            -n Pixel_5_API_30 \
            -k "system-images;android-30;default;x86_64" \
            --device "pixel_5" \
            --force

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Run Functional Tests
        uses: reactivecircus/android-emulator-runner@v2
        env:
          DETOX_DEVICE_AVD_NAME: Pixel_5_API_30
        with:
          api-level: 30
          target: default
          arch: x86_64
          avd-name: Pixel_5_API_30
          emulator-boot-timeout: 600
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -accel on
          disable-animations: true
          script: |
            adb wait-for-device
            adb shell settings put global window_animation_scale 0
            adb shell settings put global transition_animation_scale 0
            adb shell settings put global animator_duration_scale 0
            DETOX_DEVICE_AVD_NAME=Pixel_5_API_30 npx detox test --configuration android.emu.release --headless --testPathPattern 'demo-mode|navigation' --record-logs all --loglevel verbose

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-android-functional-results
          path: artifacts/
          retention-days: 7
