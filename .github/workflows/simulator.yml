name: Build & Test Simulator Apps

on:
  push:
    branches: ['**']  # Run on all branch pushes
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_e2e:
        description: 'Skip E2E tests'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: "20"

jobs:
  # ============================================
  # Detect changes to skip unnecessary builds
  # ============================================
  changes:
    name: Detect Changes
    runs-on: self-hosted
    outputs:
      ios: ${{ steps.filter.outputs.ios }}
      android: ${{ steps.filter.outputs.android }}
      source_hash: ${{ steps.hash.outputs.source_hash }}
    steps:
      - uses: actions/checkout@v4

      - name: Check for changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            ios:
              - 'src/**'
              - 'app/**'
              - 'app.json'
              - 'package.json'
              - 'plugins/**'
              - 'modules/veloqrs/**'
            android:
              - 'src/**'
              - 'app/**'
              - 'app.json'
              - 'package.json'
              - 'plugins/**'
              - 'modules/veloqrs/**'

      - name: Calculate source hash
        id: hash
        run: |
          # Include all files that affect the build (including Rust sources)
          HASH=$(cat <(find src app plugins modules .github -type f \( -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.json" -o -name "*.gradle" -o -name "*.rs" -o -name "*.toml" \) -exec sha256sum {} \; 2>/dev/null) <(sha256sum package.json app.json 2>/dev/null) | sort | sha256sum | cut -d' ' -f1 | head -c 12)
          echo "source_hash=$HASH" >> $GITHUB_OUTPUT

  # ============================================
  # iOS Simulator Builds (always runs, uses cache to skip compilation)
  # ============================================
  ios-simulator:
    needs: changes
    name: iOS ${{ matrix.config }}
    runs-on: [self-hosted, macOS]
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        config: [Debug, Release]
    outputs:
      artifact_name: ${{ steps.version.outputs.artifact_name }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Xcode
        if: runner.environment == 'github-hosted'
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '26.2'

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - run: npm ci

      - name: Get version info
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          SHORT_SHA=$(git rev-parse --short HEAD)
          CONFIG_LOWER=$(echo "${{ matrix.config }}" | tr '[:upper:]' '[:lower:]')
          # Include all files that affect the build: src, app, modules (JS + native + Rust), plugins
          SOURCE_HASH=$(cat <(find src app modules plugins -type f \( -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.json" -o -name "*.swift" -o -name "*.m" -o -name "*.mm" -o -name "*.h" -o -name "*.kt" -o -name "*.java" -o -name "*.podspec" -o -name "*.rs" -o -name "*.toml" \) -exec sha256sum {} \; 2>/dev/null) <(sha256sum package.json app.json 2>/dev/null) | sort | sha256sum | cut -d' ' -f1 | head -c 12)

          echo "artifact_name=ios-${{ matrix.config }}-${SOURCE_HASH}" >> $GITHUB_OUTPUT
          echo "filename=veloq-${VERSION}-${SHORT_SHA}-simulator-${CONFIG_LOWER}" >> $GITHUB_OUTPUT
          echo "source_hash=$SOURCE_HASH" >> $GITHUB_OUTPUT

      - name: Cache built iOS app
        id: app-cache
        uses: actions/cache@v4
        with:
          path: ios/build/Build/Products/${{ matrix.config }}-iphonesimulator/Veloq.app
          # v1: Clean slate - invalidated all old caches
          key: ios-app-v1-${{ matrix.config }}-${{ steps.version.outputs.source_hash }}

      # Always setup Rust and generate bindings if building (app-cache miss)
      # This ensures C++ files exist before any cache restoration that might reference them
      - name: Setup Rust
        if: steps.app-cache.outputs.cache-hit != 'true'
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios-sim,x86_64-apple-ios

      - name: Cache Rust
        if: steps.app-cache.outputs.cache-hit != 'true'
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: modules/veloqrs/rust
          key: ios-sim-${{ matrix.config }}

      - name: Setup C++ files for CocoaPods
        if: steps.app-cache.outputs.cache-hit != 'true'
        run: |
          # Copy committed C++ bindings to ios/cpp/ where CocoaPods can find them
          mkdir -p modules/veloqrs/ios/cpp/generated
          cp modules/veloqrs/cpp/veloqrs.h modules/veloqrs/ios/cpp/
          cp modules/veloqrs/cpp/veloqrs.cpp modules/veloqrs/ios/cpp/
          cp modules/veloqrs/cpp/generated/veloqrs.hpp modules/veloqrs/ios/cpp/generated/
          cp modules/veloqrs/cpp/generated/veloqrs.cpp modules/veloqrs/ios/cpp/generated/
          echo "✓ Copied C++ bindings to ios/cpp/"

      # Build Rust for iOS simulator (aarch64 for Apple Silicon, x86_64 for Intel)
      - name: Build Rust for iOS Simulator
        if: steps.app-cache.outputs.cache-hit != 'true'
        working-directory: modules/veloqrs/rust
        run: |
          # Build for both simulator architectures
          cargo build --release --target aarch64-apple-ios-sim -p veloqrs
          cargo build --release --target x86_64-apple-ios -p veloqrs

          # Create universal library (named veloqrs_ffi to match podspec -lveloqrs_ffi)
          mkdir -p ../ios/Frameworks/VeloqrsFFI.xcframework/ios-arm64_x86_64-simulator
          lipo -create \
            target/aarch64-apple-ios-sim/release/libveloqrs.a \
            target/x86_64-apple-ios/release/libveloqrs.a \
            -output ../ios/Frameworks/VeloqrsFFI.xcframework/ios-arm64_x86_64-simulator/libveloqrs_ffi.a

          # Create Info.plist for XCFramework
          cat > ../ios/Frameworks/VeloqrsFFI.xcframework/Info.plist << 'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>AvailableLibraries</key>
            <array>
              <dict>
                <key>LibraryIdentifier</key>
                <string>ios-arm64_x86_64-simulator</string>
                <key>LibraryPath</key>
                <string>libveloqrs_ffi.a</string>
                <key>SupportedArchitectures</key>
                <array>
                  <string>arm64</string>
                  <string>x86_64</string>
                </array>
                <key>SupportedPlatform</key>
                <string>ios</string>
                <key>SupportedPlatformVariant</key>
                <string>simulator</string>
              </dict>
            </array>
            <key>CFBundlePackageType</key>
            <string>XFWK</string>
            <key>XCFrameworkFormatVersion</key>
            <string>1.0</string>
          </dict>
          </plist>
          PLIST

          echo "✓ Built iOS simulator XCFramework"

      - name: Cache iOS prebuild
        if: steps.app-cache.outputs.cache-hit != 'true'
        id: ios-prebuild-cache
        uses: actions/cache@v4
        with:
          path: ios
          # v1: Clean slate - no restore-keys fallback to prevent stale cache issues
          key: ios-prebuild-v1-${{ runner.os }}-${{ hashFiles('app.json', 'package.json', 'package-lock.json', 'plugins/**', 'modules/veloqrs/ios/**', 'modules/veloqrs/package.json') }}

      - name: Expo Prebuild
        if: steps.app-cache.outputs.cache-hit != 'true' && steps.ios-prebuild-cache.outputs.cache-hit != 'true'
        run: npx expo prebuild --platform ios --clean

      - name: Cache CocoaPods
        if: steps.app-cache.outputs.cache-hit != 'true'
        uses: actions/cache@v4
        with:
          path: |
            ios/Pods
            ~/Library/Caches/CocoaPods
          # v1: Clean slate - includes module sources in key, no restore-keys
          key: pods-v1-${{ runner.os }}-${{ hashFiles('ios/Podfile.lock', 'modules/veloqrs/ios/**') }}

      - name: Install CocoaPods
        if: steps.app-cache.outputs.cache-hit != 'true'
        run: |
          gem install cocoapods
          cd ios && pod install

      - name: Initialize simulator
        if: steps.app-cache.outputs.cache-hit != 'true'
        run: |
          xcrun simctl list > /dev/null 2>&1 || true
          if ! xcrun simctl list devices available | grep -q "iPhone"; then
            xcodebuild -downloadPlatform iOS || exit 1
          fi

      - name: Find simulator
        if: steps.app-cache.outputs.cache-hit != 'true'
        id: simulator
        run: |
          # Use iPhone 17 for build (Xcode 26.x)
          DEVICE_UDID=$(xcrun simctl list devices available | grep -E "iPhone 17 \(" | head -1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/')
          if [ -z "$DEVICE_UDID" ]; then
            # Fallback to any available iPhone
            DEVICE_UDID=$(xcrun simctl list devices available | grep -E "iPhone" | head -1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/')
          fi
          echo "Found simulator UDID: $DEVICE_UDID"
          xcrun simctl boot "$DEVICE_UDID" || true
          echo "udid=$DEVICE_UDID" >> $GITHUB_OUTPUT

      - name: Build iOS App
        if: steps.app-cache.outputs.cache-hit != 'true'
        run: |
          xcodebuild -workspace ios/Veloq.xcworkspace \
            -scheme Veloq \
            -configuration ${{ matrix.config }} \
            -sdk iphonesimulator \
            -destination "id=${{ steps.simulator.outputs.udid }}" \
            -derivedDataPath ios/build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            2>&1 | tee ios-build.log || {
              tail -100 ios-build.log
              exit 1
            }

      - name: Skip build (cache hit)
        if: steps.app-cache.outputs.cache-hit == 'true'
        run: echo "✓ Using cached iOS app (hash ${{ steps.version.outputs.source_hash }})"

      - name: Verify and package build
        run: |
          APP_PATH="ios/build/Build/Products/${{ matrix.config }}-iphonesimulator/Veloq.app"
          if [ ! -d "$APP_PATH" ]; then
            echo "ERROR: App not found"
            exit 1
          fi
          # Verify executable exists
          if [ ! -f "$APP_PATH/Veloq" ]; then
            echo "ERROR: Missing executable at $APP_PATH/Veloq"
            ls -la "$APP_PATH/"
            exit 1
          fi
          echo "App size: $(du -sh "$APP_PATH" | cut -f1)"
          echo "Executable: $(ls -la "$APP_PATH/Veloq")"
          # Zip with -y to preserve symlinks
          cd "$(dirname "$APP_PATH")"
          zip -yr Veloq.app.zip Veloq.app
          echo "Created Veloq.app.zip ($(du -sh Veloq.app.zip | cut -f1))"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.version.outputs.artifact_name }}
          path: ios/build/Build/Products/${{ matrix.config }}-iphonesimulator/Veloq.app.zip
          retention-days: 7

      - name: Upload build log on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ios-${{ matrix.config }}-build-log
          path: ios-build.log
          retention-days: 3

  # ============================================
  # Android Build (Release for E2E - has JS bundle embedded)
  # ============================================
  android-release:
    needs: changes
    name: Android Release
    runs-on: self-hosted
    timeout-minutes: 60
    outputs:
      artifact_name: ${{ steps.version.outputs.artifact_name }}
    env:
      JAVA_TOOL_OPTIONS: "-Dhttp.agent=Gradle -Dhttps.agent=Gradle"
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - uses: android-actions/setup-android@v3

      - uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      - run: npm ci

      - name: Get version info
        id: version
        run: |
          # Include all files that affect the build: src, app, modules (JS + native + Rust), plugins
          SOURCE_HASH=$(cat <(find src app modules plugins -type f \( -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.json" -o -name "*.swift" -o -name "*.m" -o -name "*.mm" -o -name "*.h" -o -name "*.kt" -o -name "*.java" -o -name "*.podspec" -o -name "*.gradle" -o -name "*.rs" -o -name "*.toml" \) -exec sha256sum {} \; 2>/dev/null) <(sha256sum package.json app.json 2>/dev/null) | sort | sha256sum | cut -d' ' -f1 | head -c 12)
          echo "artifact_name=android-release-${SOURCE_HASH}" >> $GITHUB_OUTPUT
          echo "source_hash=$SOURCE_HASH" >> $GITHUB_OUTPUT

      - name: Cache built APK
        id: apk-cache
        uses: actions/cache@v4
        with:
          path: android/app/build/outputs/apk/release/app-release.apk
          # v1: Clean slate
          key: android-apk-v1-${{ steps.version.outputs.source_hash }}

      # Setup Rust and generate bindings BEFORE prebuild cache restoration
      # This ensures C++ files exist before CMakeLists.txt references them
      - name: Setup Rust
        if: steps.apk-cache.outputs.cache-hit != 'true'
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,x86_64-linux-android

      - name: Cache Rust
        if: steps.apk-cache.outputs.cache-hit != 'true'
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: modules/veloqrs/rust
          key: android-release

      - name: Install cargo-ndk
        if: steps.apk-cache.outputs.cache-hit != 'true'
        run: cargo install cargo-ndk

      - name: Build Rust for Android
        if: steps.apk-cache.outputs.cache-hit != 'true'
        working-directory: modules/veloqrs/rust
        run: |
          # Build for arm64 (modern devices) and x86_64 (emulator) only
          cargo ndk -t arm64-v8a -t x86_64 -o ../android/src/main/jniLibs build --release -p veloqrs
          echo "✓ Built Android .so libraries"

      - name: Cache Android prebuild
        if: steps.apk-cache.outputs.cache-hit != 'true'
        id: android-prebuild-cache
        uses: actions/cache@v4
        with:
          # Cache generated project files, but EXCLUDE build outputs to prevent stale .so conflicts
          path: |
            android
            !android/build
            !android/.gradle
            !android/.cxx
            !android/app/build
            !android/app/.cxx
          # v2: exclude build directories to prevent stale CMake outputs
          key: android-prebuild-v2-${{ runner.os }}-${{ hashFiles('app.json', 'package.json', 'modules/veloqrs/android/**', 'modules/veloqrs/package.json') }}

      - name: Expo Prebuild
        if: steps.apk-cache.outputs.cache-hit != 'true' && steps.android-prebuild-cache.outputs.cache-hit != 'true'
        run: npx expo prebuild --platform android --clean

      - name: Install Gradle init script
        if: steps.apk-cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p ~/.gradle
          cp .github/ci-init.gradle ~/.gradle/init.gradle

      - name: Free disk space
        if: steps.apk-cache.outputs.cache-hit != 'true' && runner.environment == 'github-hosted'
        run: |
          sudo rm -rf /usr/local/lib/android/sdk/ndk
          sudo rm -rf /usr/local/lib/android/sdk/build-tools/3[0-3]*
          sudo rm -rf /usr/local/lib/android/sdk/platforms/android-[1-2]*
          sudo rm -rf /usr/local/lib/android/sdk/platforms/android-3[0-2]
          sudo docker image prune --all --force || true
          df -h

      - name: Build Release APK
        if: steps.apk-cache.outputs.cache-hit != 'true'
        run: |
          # Only build arm64-v8a (modern devices) and x86_64 (emulator) to save disk space
          cd android && ./gradlew assembleRelease \
            -PreactNativeArchitectures=arm64-v8a,x86_64 \
            --no-daemon --no-build-cache

      - name: Skip build (cache hit)
        if: steps.apk-cache.outputs.cache-hit == 'true'
        run: echo "✓ Using cached APK (hash ${{ steps.version.outputs.source_hash }})"

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.version.outputs.artifact_name }}
          path: android/app/build/outputs/apk/release/app-release.apk
          retention-days: 7

  # ============================================
  # E2E Tests - iOS with Maestro
  # ============================================
  e2e-ios:
    needs: ios-simulator
    if: ${{ !inputs.skip_e2e }}
    name: E2E iOS (Maestro)
    runs-on: [self-hosted, macOS]
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - run: npm ci

      - name: Download iOS app
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.ios-simulator.outputs.artifact_name }}
          path: /tmp/ios-artifact

      - name: Extract iOS app
        run: |
          mkdir -p ios/build/Build/Products/Release-iphonesimulator
          unzip /tmp/ios-artifact/Veloq.app.zip -d ios/build/Build/Products/Release-iphonesimulator/

      - name: Install Maestro
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: Find and boot simulator
        id: simulator
        run: |
          # Use iPhone 17 Pro Max for tests
          DEVICE="iPhone 17 Pro Max"
          UDID=$(xcrun simctl list devices available | grep "$DEVICE" | head -1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/')
          if [ -z "$UDID" ]; then
            UDID=$(xcrun simctl list devices available | grep "iPhone" | head -1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/')
          fi
          echo "Using simulator: $UDID"
          xcrun simctl boot "$UDID" || true
          echo "udid=$UDID" >> $GITHUB_OUTPUT

      - name: Install app on simulator
        run: |
          xcrun simctl install "${{ steps.simulator.outputs.udid }}" ios/build/Build/Products/Release-iphonesimulator/Veloq.app

      - name: Run Maestro tests
        env:
          MAESTRO_DRIVER_STARTUP_TIMEOUT: 120000
        run: |
          export PATH="$HOME/.maestro/bin:$PATH"

          # Wait for simulator to be fully ready
          sleep 5

          # Run smoke test
          mkdir -p screenshots
          maestro test .maestro/smoke.yaml --format junit --output maestro-report.xml --no-ansi

      - name: Collect screenshots
        if: always()
        run: |
          mkdir -p screenshots-flat
          find ~/.maestro -name "*.png" -exec cp {} screenshots-flat/ \; 2>/dev/null || true
          for f in screenshots-flat/*.png; do
            [ -f "$f" ] && mv "$f" "${f%.png}-ios.png" 2>/dev/null || true
          done
          ls -la screenshots-flat/ || true

      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-ios
          path: screenshots-flat/
          retention-days: 14

      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-ios-report
          path: maestro-report*.xml
          retention-days: 7

  # ============================================
  # E2E Tests - Android with Maestro
  # ============================================
  e2e-android:
    needs: android-release
    if: ${{ !inputs.skip_e2e }}
    name: E2E Android (Maestro)
    runs-on: self-hosted
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Download APK
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.android-release.outputs.artifact_name }}
          path: /tmp/android-artifact

      - name: Install Maestro
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: Enable KVM (GitHub-hosted only)
        if: runner.environment == 'github-hosted'
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Run Maestro tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 29
          target: default
          arch: x86_64
          ram-size: 2048M
          emulator-boot-timeout: 600
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -accel on
          disable-animations: true
          script: |
            export PATH="$HOME/.maestro/bin:$PATH"

            # Install APK
            adb install /tmp/android-artifact/app-release.apk

            # Give app time to install and emulator to stabilize
            sleep 10

            # Run smoke test
            mkdir -p screenshots
            maestro test .maestro/smoke.yaml --format junit --output maestro-report.xml --no-ansi

      - name: Collect screenshots
        if: always()
        run: |
          mkdir -p screenshots-flat
          find ~/.maestro -name "*.png" -exec cp {} screenshots-flat/ \; 2>/dev/null || true
          for f in screenshots-flat/*.png; do
            [ -f "$f" ] && mv "$f" "${f%.png}-android.png" 2>/dev/null || true
          done
          ls -la screenshots-flat/ || true

      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-android
          path: screenshots-flat/
          retention-days: 14

      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-android-report
          path: maestro-report*.xml
          retention-days: 7
