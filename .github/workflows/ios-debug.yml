name: iOS Debug Build

on:
  workflow_dispatch:
    inputs:
      signing_method:
        description: "Certificate import method"
        required: true
        default: "apple-actions"
        type: choice
        options:
          - apple-actions       # Use Apple-Actions/import-codesign-certs (Recommended)
          - dedicated-keychain  # Use Match with dedicated keychain
          - pre-sign-frameworks # Pre-sign frameworks with ad-hoc

env:
  NODE_VERSION: "20"

jobs:
  build-ios:
    name: iOS Debug Build
    runs-on: macos-15
    timeout-minutes: 25
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "${{ env.NODE_VERSION }}"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      # Download tracematch binaries
      - name: Download tracematch binaries
        run: |
          TRACEMATCH_VERSION=$(node -p "require('./package.json').tracematchVersion")
          echo "=== Downloading tracematch v${TRACEMATCH_VERSION} for iOS ==="
          RELEASE_URL="https://github.com/evanjt/tracematch/releases/download/${TRACEMATCH_VERSION}"

          curl -sL "${RELEASE_URL}/tracematch-ios-${TRACEMATCH_VERSION}.zip" -o /tmp/ios.zip
          unzip -q /tmp/ios.zip -d /tmp/tracematch

          mkdir -p modules/route-matcher-native/ios/Frameworks
          cp -r /tmp/tracematch/ios/RouteMatcherFFI.xcframework \
                modules/route-matcher-native/ios/Frameworks/

          mkdir -p modules/route-matcher-native/ios/Generated
          cp /tmp/tracematch/ios/Generated/tracematch.swift \
             modules/route-matcher-native/ios/Generated/
          cp /tmp/tracematch/ios/Generated/tracematchFFI.h \
             modules/route-matcher-native/ios/Generated/
          cp /tmp/tracematch/ios/Generated/tracematchFFI.modulemap \
             modules/route-matcher-native/ios/Generated/

          echo "=== Verifying installation ==="
          ls -la modules/route-matcher-native/ios/Frameworks/
          ls -la modules/route-matcher-native/ios/Generated/

      - name: Generate native project
        run: npx expo prebuild --platform ios

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"
          bundler-cache: true
          working-directory: fastlane

      - name: Install Pods
        run: cd ios && pod install

      # ============================================
      # Option 1: Dedicated Keychain (default)
      # ============================================
      - name: Setup SSH for Match
        if: inputs.signing_method == 'dedicated-keychain' || inputs.signing_method == ''
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.MATCH_SSH_PRIVATE_KEY }}

      - name: Create dedicated signing keychain
        if: inputs.signing_method == 'dedicated-keychain' || inputs.signing_method == ''
        run: |
          echo "=== Creating dedicated signing keychain ==="

          # Delete if exists from previous run
          security delete-keychain build.keychain 2>/dev/null || true

          # Create new keychain with empty password
          security create-keychain -p "" build.keychain

          # Add to search list (prepend for priority)
          security list-keychains -d user -s build.keychain $(security list-keychains -d user | tr -d '"')

          # Unlock and configure
          security unlock-keychain -p "" build.keychain
          security set-keychain-settings -t 7200 -u build.keychain

          # Set as default
          security default-keychain -s build.keychain

          echo "=== Keychain created ==="
          security list-keychains -d user

      - name: Sync certificates to dedicated keychain
        if: inputs.signing_method == 'dedicated-keychain' || inputs.signing_method == ''
        env:
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          FASTLANE_TEAM_ID: ${{ secrets.FASTLANE_TEAM_ID }}
          MATCH_KEYCHAIN_NAME: build.keychain
          MATCH_KEYCHAIN_PASSWORD: ""
        working-directory: fastlane
        run: |
          echo "=== Syncing certificates to dedicated keychain ==="
          bundle exec fastlane match appstore --readonly --verbose

          echo "=== Verifying signing identities ==="
          security find-identity -v -p codesigning

      # ============================================
      # Option 2: Apple-Actions (requires p12 secrets)
      # ============================================
      - name: Import certificates via Apple-Actions
        if: inputs.signing_method == 'apple-actions'
        uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.IOS_DISTRIBUTION_CERT_P12 }}
          p12-password: ${{ secrets.IOS_DISTRIBUTION_CERT_PASSWORD }}

      - name: Sync provisioning profiles only
        if: inputs.signing_method == 'apple-actions'
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.MATCH_SSH_PRIVATE_KEY }}

      - name: Download provisioning profiles
        if: inputs.signing_method == 'apple-actions'
        env:
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          FASTLANE_TEAM_ID: ${{ secrets.FASTLANE_TEAM_ID }}
        working-directory: fastlane
        run: bundle exec fastlane match appstore --readonly

      # ============================================
      # Option 3: Pre-sign frameworks
      # ============================================
      - name: Pre-sign frameworks with ad-hoc
        if: inputs.signing_method == 'pre-sign-frameworks'
        run: |
          echo "=== Pre-signing frameworks with ad-hoc identity ==="
          find ios/Pods -name "*.framework" -type d | while read fw; do
            echo "Signing: $fw"
            codesign --force --sign - --timestamp=none "$fw" 2>/dev/null || true
          done
          echo "=== Done pre-signing ==="

      - name: Setup signing for pre-sign method
        if: inputs.signing_method == 'pre-sign-frameworks'
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.MATCH_SSH_PRIVATE_KEY }}

      - name: Sync certificates for pre-sign method
        if: inputs.signing_method == 'pre-sign-frameworks'
        env:
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          FASTLANE_TEAM_ID: ${{ secrets.FASTLANE_TEAM_ID }}
        working-directory: fastlane
        run: bundle exec fastlane match appstore --readonly

      # ============================================
      # Build
      # ============================================
      - name: Pre-build diagnostics
        run: |
          echo "=== Pre-build Diagnostics ==="
          echo "--- System Info ---"
          sw_vers
          xcodebuild -version

          echo "--- Signing identities ---"
          security find-identity -v -p codesigning

          echo "--- Network test (timestamp server) ---"
          curl -sI --connect-timeout 5 https://timestamp.apple.com/ts01 && echo "OK" || echo "UNREACHABLE"

      - name: Build signed IPA
        timeout-minutes: 15
        env:
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          FASTLANE_TEAM_ID: ${{ secrets.FASTLANE_TEAM_ID }}
        working-directory: fastlane
        run: |
          echo "=== Starting build at $(date) ==="
          bundle exec fastlane ios build_release
          echo "=== Build completed at $(date) ==="

      - name: Verify IPA created
        run: |
          echo "=== Checking for IPA ==="
          find . -name "*.ipa" -type f
          ls -la fastlane/artifacts/ 2>/dev/null || echo "No artifacts directory"

      - name: Upload IPA
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ios-debug-ipa
          path: fastlane/artifacts/*.ipa
          retention-days: 7

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ios-debug-logs
          path: |
            fastlane/artifacts/*.log
            ~/Library/Logs/gym/*.log
          retention-days: 7
