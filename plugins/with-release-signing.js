const { withAppBuildGradle } = require("@expo/config-plugins");

/**
 * Expo config plugin that configures release signing from keystore.properties.
 *
 * This plugin modifies android/app/build.gradle to:
 * 1. Load keystore.properties file if it exists (for CI builds)
 * 2. Add a release signing config using those properties
 * 3. Use the release signing config for release builds
 *
 * The keystore.properties file is created by the CI pipeline and contains:
 * - storeFile=release.keystore
 * - storePassword=<from secrets>
 * - keyAlias=<from secrets>
 * - keyPassword=<from secrets>
 */

function withReleaseSigning(config) {
  return withAppBuildGradle(config, (config) => {
    const contents = config.modResults.contents;

    // Skip if already configured
    if (contents.includes("keystorePropertiesFile")) {
      return config;
    }

    // Add keystore properties loading at the top of android block
    const keystorePropertiesLoader = `
def keystorePropertiesFile = rootProject.file("keystore.properties")
def keystoreProperties = new Properties()
if (keystorePropertiesFile.exists()) {
    keystoreProperties.load(new FileInputStream(keystorePropertiesFile))
}
`;

    // Add release signing config inside signingConfigs block
    const releaseSigningConfig = `
        release {
            if (keystorePropertiesFile.exists()) {
                storeFile file(keystoreProperties['storeFile'])
                storePassword keystoreProperties['storePassword']
                keyAlias keystoreProperties['keyAlias']
                keyPassword keystoreProperties['keyPassword']
            }
        }`;

    // Insert keystore properties loader before android block
    let modified = contents.replace(
      /^android \{/m,
      `${keystorePropertiesLoader}\nandroid {`
    );

    // Add release signing config after debug signing config
    // The debug config is generated by Expo and looks like:
    // signingConfigs {
    //     debug {
    //         storeFile file('debug.keystore')
    //         ...
    //     }
    // }
    modified = modified.replace(
      /(signingConfigs\s*\{[\s\S]*?debug\s*\{[\s\S]*?\})/,
      `$1${releaseSigningConfig}`
    );

    // Change release buildType to use release signing config if keystore exists
    // Replace: signingConfig signingConfigs.debug
    // With: signingConfig keystorePropertiesFile.exists() ? signingConfigs.release : signingConfigs.debug
    modified = modified.replace(
      /(buildTypes\s*\{[\s\S]*?release\s*\{[\s\S]*?)signingConfig\s+signingConfigs\.debug/,
      "$1signingConfig keystorePropertiesFile.exists() ? signingConfigs.release : signingConfigs.debug"
    );

    config.modResults.contents = modified;
    return config;
  });
}

module.exports = withReleaseSigning;
